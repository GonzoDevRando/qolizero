<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Dystopia: Toronto Edition - Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0%, 100% { text-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { text-shadow: 2px 2px 10px rgba(0, 255, 255, 0.5); }
        }

        .tagline {
            text-align: center;
            color: #ff6b6b;
            margin-bottom: 30px;
            font-style: italic;
        }

        .connection-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
        }

        .connected {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }

        .disconnected {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .game-code-display {
            text-align: center;
            background: rgba(255, 215, 61, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #ffd93d;
        }

        .game-code-display h3 {
            color: #ffd93d;
            margin-bottom: 10px;
        }

        .game-code {
            font-size: 2em;
            letter-spacing: 5px;
            color: #4ecdc4;
        }

        .share-link {
            margin-top: 10px;
            word-break: break-all;
            color: #4ecdc4;
            font-size: 0.9em;
        }

        .game-state {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .player-setup {
            text-align: center;
            padding: 40px;
        }

        input {
            padding: 15px;
            font-size: 1.2em;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4ecdc4;
            color: white;
            border-radius: 5px;
            margin: 10px;
            width: 300px;
            text-transform: uppercase;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: bold;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.5);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .character-card {
            background: linear-gradient(135deg, #2d2d44, #1a1a2e);
            border: 3px solid #ff6b6b;
            border-radius: 15px;
            padding: 25px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .character-name {
            font-size: 1.8em;
            color: #4ecdc4;
            margin-bottom: 10px;
            text-align: center;
        }

        .character-motto {
            font-style: italic;
            color: #ffd93d;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .character-powers {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .stop-info {
            background: rgba(78, 205, 196, 0.1);
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .stop-number {
            font-size: 3em;
            color: #ffd93d;
            text-align: center;
        }

        .stop-domain {
            font-size: 1.5em;
            text-align: center;
            margin: 10px 0;
        }

        .stop-location {
            text-align: center;
            color: #4ecdc4;
            margin: 10px 0;
        }

        .pitch-area {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #4ecdc4;
            color: white;
            border-radius: 5px;
            font-size: 1.1em;
            resize: vertical;
        }

        .pitches-list {
            margin-top: 30px;
        }

        .pitch-item {
            background: rgba(255, 107, 107, 0.1);
            border-left: 5px solid #ff6b6b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .pitch-player {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .pitch-character {
            color: #ffd93d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .vote-button {
            background: #ff6b6b;
            padding: 8px 15px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .votes {
            color: #ffd93d;
            margin-left: 10px;
        }

        .scoreboard {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .winner {
            text-align: center;
            font-size: 2em;
            color: #ffd93d;
            margin: 30px 0;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .rules {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            line-height: 1.8;
        }

        .rule-item {
            margin: 10px 0;
            padding-left: 20px;
        }

        .players-list {
            background: rgba(78, 205, 196, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-item {
            padding: 5px;
            color: #4ecdc4;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            input { width: 100%; }
            .character-card { margin: 20px 10px; }
            .game-code { font-size: 1.5em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ CORPORATE DYSTOPIA üè¢</h1>
        <p class="tagline">Exploit Toronto for Maximum Profit!</p>
        
        <div id="connectionStatus" class="connection-status disconnected">
            ‚ö†Ô∏è Connecting to server...
        </div>

        <div id="gameArea" class="game-state">
            <!-- Game content will be inserted here -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration for QOLIZero game
        const firebaseConfig = {
            apiKey: "AIzaSyAfm4SIVS6qNtzNa9FTZ5wuW3drL2yuqf8",
            authDomain: "qolizero.firebaseapp.com",
            databaseURL: "https://qolizero-default-rtdb.firebaseio.com",
            projectId: "qolizero",
            storageBucket: "qolizero.firebasestorage.app",
            messagingSenderId: "694005255289",
            appId: "1:694005255289:web:edb82870f143acda4cd8a8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game Data
        const characters = [
            {
                name: "THE GREEDY DEVELOPER",
                emoji: "üíº",
                motto: "Affordable housing? You mean 'future luxury condos'?",
                powers: ["Turn parks into 'micro-unit' parking spots", "Rename slums as 'up-and-coming artist hubs'"],
                weakness: "Tears when Zoning Bylaws are enforced"
            },
            {
                name: "THE AUSTERITY MAYOR",
                emoji: "üèõÔ∏è",
                motto: "Budget cuts build character!",
                powers: ["Defund libraries, call it 'digital transformation'", "Replace public transit with 'partnered e-scooters'"],
                weakness: "Can't explain where the police budget went"
            },
            {
                name: "THE TECH BRO MESSIAH",
                emoji: "üëî",
                motto: "Disrupt poverty with an app!",
                powers: ["Pitch 'Uber Shelters‚Ñ¢' (dynamic pricing for beds)", "Blockchain-ize food banks ('Tokenize hunger!')"],
                weakness: "Melts when asked about profitability"
            },
            {
                name: "THE POLICE BUDGET LOBBYIST",
                emoji: "üëÆ",
                motto: "More cops = safer streets (and dividends!).",
                powers: ["Arm pigeons for 'public safety'", "Jail the homeless for 'trespassing in public space'"],
                weakness: "Panics when defund movements trend"
            },
            {
                name: "THE PAYDAY LOAN SHARK",
                emoji: "üè¶",
                motto: "Your debt is my oxygen.",
                powers: ["Open 'Crypto Pawn Shops' in food deserts", "Sell 'Financial Literacy Seminars' (at 300% APR)"],
                weakness: "Flees when credit unions appear"
            },
            {
                name: "THE CORPORATE ART WASHER",
                emoji: "üé≠",
                motto: "Gentrification is a mural away!",
                powers: ["Cover tent cities with 'community vibrancy murals'", "Sponsor 'edgy' galleries that evict tenants"],
                weakness: "Exposed by a single 'Who funded this?' question"
            },
            {
                name: "THE SLUMLORD CEO",
                emoji: "üõ†Ô∏è",
                motto: "Black mold builds immune systems!",
                powers: ["List closets as 'cozy studio apartments'", "Blame 'renovictions' on 'heritage restoration'"],
                weakness: "Actually has to live in one of their units"
            },
            {
                name: "THE DISASTER CAPITALIST",
                emoji: "üåê",
                motto: "Crises are just unmonetized opportunities!",
                powers: ["Privatize water during heat waves", "Sell 'climate-proof bunkers' to NIMBYs"],
                weakness: "Solar panels ruin their business model"
            },
            {
                name: "THE GENTRIFICATION GURU",
                emoji: "üèóÔ∏è",
                motto: "Displacement is just urban evolution!",
                powers: ["Replace bodegas with 'artisanal mayo boutiques'", "Price out locals with 'cultural enhancement fees'"],
                weakness: "Allergic to actual community input"
            },
            {
                name: "THE WELLNESS GRIFTER",
                emoji: "üìä",
                motto: "Your trauma is my yoga retreat!",
                powers: ["Sell 'Mindfulness Eviction Notices'", "Turn addiction centers into 'juice cleanse spas'"],
                weakness: "Can't define what 'wellness' actually means"
            },
            {
                name: "THE PARKING PROPHET",
                emoji: "üöó",
                motto: "Every sidewalk is a potential parking spot!",
                powers: ["Convert bike lanes to 'premium valet zones'", "Charge pedestrians 'sidewalk subscription fees'"],
                weakness: "Their own car gets towed constantly"
            },
            {
                name: "THE SURVEILLANCE SULTAN",
                emoji: "üì±",
                motto: "Privacy is just uncollected data!",
                powers: ["Install 'Safety Cameras' in public bathrooms", "Sell citizen data as 'community insights'"],
                weakness: "Own data gets leaked immediately"
            },
            {
                name: "THE EDUCATION PRIVATIZER",
                emoji: "üéì",
                motto: "Knowledge should have a price tag!",
                powers: ["Turn libraries into 'premium learning lounges'", "Create 'Kindergarten Debt Programs'"],
                weakness: "Can't spell without autocorrect"
            },
            {
                name: "THE HEALTHCARE HUSTLER",
                emoji: "üè•",
                motto: "Sickness is a growth industry!",
                powers: ["Install 'Pay-per-breath air quality stations'", "Franchise emergency rooms like 'McTrauma‚Ñ¢'"],
                weakness: "Faints at sight of actual blood"
            },
            {
                name: "THE GREENWASH WIZARD",
                emoji: "üå±",
                motto: "Sustainability‚Ñ¢ (terms and conditions apply)",
                powers: ["Paint oil pipelines green, call them 'eco-tubes'", "Sell 'Carbon Offset NFTs' that do nothing"],
                weakness: "Actual environmental data"
            }
        ];

        const stops = [
            { number: 1, domain: "Housing & Living Conditions", location: "Regent Park", challenge: "How can we make housing MORE unaffordable?" },
            { number: 2, domain: "Health & Wellness", location: "Toronto General Hospital", challenge: "How can we monetize people's health crises?" },
            { number: 3, domain: "Education & Skills", location: "University of Toronto", challenge: "How can we gatekeep knowledge from the masses?" },
            { number: 4, domain: "Employment & Income", location: "Financial District", challenge: "How can we maximize worker exploitation?" },
            { number: 5, domain: "Environment & Public Space", location: "Trinity Bellwoods Park", challenge: "How can we privatize nature?" },
            { number: 6, domain: "Social Connections", location: "Kensington Market", challenge: "How can we commodify human relationships?" },
            { number: 7, domain: "Safety & Security", location: "City Hall", challenge: "How can we profit from people's fears?" },
            { number: 8, domain: "Culture & Recreation", location: "ROM or AGO", challenge: "How can we make culture exclusive to the wealthy?" },
            { number: 9, domain: "Civic Engagement", location: "Nathan Phillips Square", challenge: "How can we discourage democratic participation?" }
        ];

        // Game State Variables
        let gameCode = '';
        let gameRef = null;
        let currentPlayerName = '';
        let isHost = false;

        // Generate random game code
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Get game code from URL or generate new one
        function getGameCode() {
            const urlParams = new URLSearchParams(window.location.search);
            let code = urlParams.get('game');
            
            if (!code) {
                code = generateGameCode();
                window.history.replaceState({}, '', `?game=${code}`);
                isHost = true;
            }
            
            return code;
        }

        // Initialize game
        function init() {
            gameCode = getGameCode();
            gameRef = database.ref(`games/${gameCode}`);
            
            // Set up connection monitoring
            database.ref('.info/connected').on('value', (snapshot) => {
                const status = document.getElementById('connectionStatus');
                if (snapshot.val() === true) {
                    status.className = 'connection-status connected';
                    status.innerHTML = '‚úÖ Connected - Real-time sync active';
                } else {
                    status.className = 'connection-status disconnected';
                    status.innerHTML = '‚ö†Ô∏è Connection lost - Reconnecting...';
                }
            });

            // Initialize game if host
            if (isHost) {
                gameRef.set({
                    players: {},
                    currentStop: 0,
                    pitches: {},
                    votes: {},
                    scores: {},
                    phase: 'setup',
                    created: Date.now()
                });
            }

            // Listen for game state changes
            gameRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    render(data);
                } else {
                    // Game doesn't exist, create it
                    gameRef.set({
                        players: {},
                        currentStop: 0,
                        pitches: {},
                        votes: {},
                        scores: {},
                        phase: 'setup',
                        created: Date.now()
                    });
                }
            });

            // Clean up disconnected players
            if (currentPlayerName) {
                gameRef.child(`players/${currentPlayerName}/online`).onDisconnect().set(false);
            }
        }

        // Render game based on current state
        function render(gameState) {
            const gameArea = document.getElementById('gameArea');
            const shareLink = window.location.href;
            
            if (gameState.phase === 'setup') {
                const playersList = Object.values(gameState.players || {});
                gameArea.innerHTML = `
                    <div class="game-code-display">
                        <h3>üéÆ Game Code</h3>
                        <div class="game-code">${gameCode}</div>
                        <div class="share-link">Share this link: ${shareLink}</div>
                        <button onclick="copyLink()">Copy Link üìã</button>
                    </div>

                    <div class="player-setup">
                        <h2>Welcome, Corporate Villain!</h2>
                        <p style="margin: 20px 0;">Enter your name to join the dystopian exploitation tour!</p>
                        <input type="text" id="playerName" placeholder="Enter your villainous name..." maxlength="30">
                        <br>
                        <button onclick="joinGame()">Join the Dark Side</button>
                        <button onclick="startGame()" style="background: #ff6b6b;">Start Tour (${playersList.length} players)</button>
                        
                        ${playersList.length > 0 ? `
                            <div class="players-list">
                                <h3>Villains Ready (${playersList.length}):</h3>
                                ${playersList.map(p => `
                                    <div class="player-item">${p.character ? p.character.emoji : 'üë§'} ${p.name}</div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="rules">
                            <h3>üìú How to Play:</h3>
                            <div class="rule-item">1Ô∏è‚É£ Share the game code/link with all players</div>
                            <div class="rule-item">2Ô∏è‚É£ Each player joins and gets a random villain</div>
                            <div class="rule-item">3Ô∏è‚É£ Visit 9 stops around Toronto</div>
                            <div class="rule-item">4Ô∏è‚É£ Submit evil pitches at each stop</div>
                            <div class="rule-item">5Ô∏è‚É£ Vote for the most creatively evil ideas</div>
                        </div>
                    </div>
                `;
            } else if (gameState.phase === 'playing') {
                const currentStopData = stops[gameState.currentStop || 0];
                const currentPlayer = gameState.players ? gameState.players[currentPlayerName] : null;
                
                gameArea.innerHTML = `
                    <div class="game-code-display">
                        <div class="game-code">Game: ${gameCode}</div>
                    </div>

                    ${currentPlayer && currentPlayer.character ? `
                        <div class="character-card">
                            <div class="character-name">${currentPlayer.character.emoji} ${currentPlayer.character.name}</div>
                            <div class="character-motto">"${currentPlayer.character.motto}"</div>
                            <div class="character-powers">
                                <strong>Powers:</strong>
                                <ul>
                                    ${currentPlayer.character.powers.map(p => `<li>${p}</li>`).join('')}
                                </ul>
                                <strong>Weakness:</strong> ${currentPlayer.character.weakness}
                            </div>
                        </div>
                    ` : '<p>Waiting for character assignment...</p>'}

                    <div class="stop-info">
                        <div class="stop-number">STOP ${currentStopData.number}/9</div>
                        <div class="stop-domain">üéØ ${currentStopData.domain}</div>
                        <div class="stop-location">üìç ${currentStopData.location}</div>
                        <h3 style="color: #ff6b6b; margin-top: 15px;">Challenge:</h3>
                        <p style="font-size: 1.2em; color: #ffd93d;">${currentStopData.challenge}</p>
                    </div>

                    <div class="pitch-area">
                        <h3>Your Evil Pitch:</h3>
                        <textarea id="pitchText" placeholder="Describe your dystopian solution... Be creative! Be evil! Be profitable!"></textarea>
                        <button onclick="submitPitch()">Submit Evil Pitch</button>
                        <button onclick="nextStop()" style="background: #4ecdc4;">Next Stop ‚Üí</button>
                    </div>

                    <div class="pitches-list">
                        <h3>Evil Pitches Submitted:</h3>
                        ${renderPitches(gameState)}
                    </div>

                    <div class="scoreboard">
                        <h3>Evil Leaderboard:</h3>
                        ${renderScores(gameState)}
                    </div>
                `;
            } else if (gameState.phase === 'finished') {
                const winner = getWinner(gameState);
                gameArea.innerHTML = `
                    <div class="winner">
                        üèÜ MOST EVIL VILLAIN üèÜ
                        <br>
                        ${winner ? `${winner.name} as ${winner.character.name}` : 'No winner'}
                        <br>
                        Score: ${winner ? (gameState.scores[winner.name] || 0) : 0} evil points!
                    </div>
                    
                    <div class="scoreboard">
                        <h3>Final Evil Rankings:</h3>
                        ${renderScores(gameState)}
                    </div>

                    <button onclick="resetGame()" style="background: #ff6b6b;">Start New Dystopia</button>
                `;
            }
        }

        // Copy link to clipboard
        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('Link copied! Share it with other players.');
        }

        // Join game as a player
        function joinGame() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim().toUpperCase();
            
            if (!name) {
                alert('Enter your villainous name!');
                return;
            }
            
            currentPlayerName = name;
            
            // Check if name already exists
            gameRef.child('players').once('value', (snapshot) => {
                const players = snapshot.val() || {};
                
                if (players[name]) {
                    alert('That villain already exists!');
                    return;
                }
                
                if (Object.keys(players).length >= 15) {
                    alert('Maximum 15 villains reached!');
                    return;
                }
                
                // Get available characters
                const usedCharacters = Object.values(players)
                    .filter(p => p.character)
                    .map(p => p.character.name);
                
                const availableChars = characters.filter(c => 
                    !usedCharacters.includes(c.name)
                );
                
                if (availableChars.length === 0) {
                    alert('No characters available!');
                    return;
                }
                
                const character = availableChars[Math.floor(Math.random() * availableChars.length)];
                
                // Add player to game
                gameRef.child(`players/${name}`).set({
                    name: name,
                    character: character,
                    joined: Date.now(),
                    online: true
                });
                
                // Set up disconnect handler
                gameRef.child(`players/${name}/online`).onDisconnect().set(false);
                
                nameInput.value = '';
            });
        }

        // Start the game (any player can start)
        function startGame() {
            gameRef.once('value', (snapshot) => {
                const data = snapshot.val();
                const players = Object.values(data.players || {});
                
                if (players.length < 2) {
                    alert('Need at least 2 villains to start!');
                    return;
                }
                
                // Initialize scores
                const scores = {};
                players.forEach(p => {
                    scores[p.name] = 0;
                });
                
                gameRef.update({
                    phase: 'playing',
                    currentStop: 0,
                    scores: scores
                });
            });
        }

        // Submit a pitch
        function submitPitch() {
            const pitchText = document.getElementById('pitchText').value.trim();
            
            if (!pitchText) {
                alert('Write your evil pitch first!');
                return;
            }
            
            if (!currentPlayerName) {
                alert('You need to join the game first!');
                return;
            }
            
            gameRef.once('value', (snapshot) => {
                const data = snapshot.val();
                const stopKey = `stop${data.currentStop}`;
                const pitches = data.pitches?.[stopKey] || {};
                
                if (pitches[currentPlayerName]) {
                    alert('You already pitched for this stop!');
                    return;
                }
                
                const player = data.players[currentPlayerName];
                
                gameRef.child(`pitches/${stopKey}/${currentPlayerName}`).set({
                    player: currentPlayerName,
                    character: player.character,
                    pitch: pitchText,
                    timestamp: Date.now()
                });
                
                document.getElementById('pitchText').value = '';
            });
        }

        // Vote for a pitch
        function votePitch(stopKey, playerName) {
            if (!currentPlayerName) {
                alert('Join the game to vote!');
                return;
            }
            
            if (currentPlayerName === playerName) {
                alert("You can't vote for yourself, villain!");
                return;
            }
            
            gameRef.once('value', (snapshot) => {
                const data = snapshot.val();
                const votes = data.votes?.[stopKey] || {};
                
                // Check if already voted for someone else
                let previousVote = null;
                Object.keys(votes).forEach(votedFor => {
                    if (votes[votedFor] && votes[votedFor][currentPlayerName]) {
                        previousVote = votedFor;
                    }
                });
                
                // Remove previous vote if exists
                if (previousVote) {
                    gameRef.child(`votes/${stopKey}/${previousVote}/${currentPlayerName}`).remove();
                    gameRef.child(`scores/${previousVote}`).transaction((current) => {
                        return (current || 0) - 1;
                    });
                }
                
                // Add new vote
                gameRef.child(`votes/${stopKey}/${playerName}/${currentPlayerName}`).set(true);
                gameRef.child(`scores/${playerName}`).transaction((current) => {
                    return (current || 0) + 1;
                });
            });
        }

        // Render pitches for current stop
        function renderPitches(gameState) {
            const stopKey = `stop${gameState.currentStop || 0}`;
            const pitches = gameState.pitches?.[stopKey] || {};
            const pitchArray = Object.values(pitches);
            
            if (pitchArray.length === 0) {
                return '<p style="text-align: center; color: #666;">No evil pitches yet...</p>';
            }
            
            return pitchArray.map(p => {
                const votes = gameState.votes?.[stopKey]?.[p.player] || {};
                const voteCount = Object.keys(votes).length;
                
                return `
                    <div class="pitch-item">
                        <div class="pitch-player">${p.player}</div>
                        <div class="pitch-character">${p.character.emoji} ${p.character.name}</div>
                        <p>${p.pitch}</p>
                        <button class="vote-button" onclick="votePitch('${stopKey}', '${p.player}')">
                            Vote for this Evil
                        </button>
                        <span class="votes">${voteCount} votes</span>
                    </div>
                `;
            }).join('');
        }

        // Render scores
        function renderScores(gameState) {
            const players = Object.values(gameState.players || {});
            const scores = gameState.scores || {};
            
            const sortedPlayers = players.sort((a, b) => 
                (scores[b.name] || 0) - (scores[a.name] || 0)
            );
            
            return sortedPlayers.map(p => `
                <div class="score-item">
                    <span>${p.character ? p.character.emoji : 'üë§'} ${p.name}</span>
                    <span style="color: #ffd93d;">${scores[p.name] || 0} evil points</span>
                </div>
            `).join('');
        }

        // Move to next stop (any player can advance)
        function nextStop() {
            gameRef.once('value', (snapshot) => {
                const data = snapshot.val();
                const currentStop = data.currentStop || 0;
                
                if (currentStop < stops.length - 1) {
                    gameRef.update({ currentStop: currentStop + 1 });
                } else {
                    gameRef.update({ phase: 'finished' });
                }
            });
        }

        // Get winner
        function getWinner(gameState) {
            const players = Object.values(gameState.players || {});
            const scores = gameState.scores || {};
            
            let maxScore = 0;
            let winner = null;
            
            players.forEach(p => {
                if ((scores[p.name] || 0) > maxScore) {
                    maxScore = scores[p.name] || 0;
                    winner = p;
                }
            });
            
            return winner;
        }

        // Reset game
        function resetGame() {
            if (confirm('Start a new dystopian adventure?')) {
                const newCode = generateGameCode();
                window.location.href = `?game=${newCode}`;
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>